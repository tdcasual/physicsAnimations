# Vue 3 SPA 全站重构设计（数据零丢失）

日期：2026-02-12  
状态：已确认（Brainstorming 结果落盘）  
项目：`physicsAnimations`

## 1. 背景与目标

当前前端采用原生 HTML + JS 的单文件主控模式，`assets/app.js` 已达到超大体量，页面状态、事件绑定和 DOM 操作高度集中，维护成本持续上升。目标是在不丢失任何现有数据的前提下，完成前端架构升级，提升可维护性、可测试性和迭代效率。

本次已确认的方向如下：

- 技术栈：`Vue 3 + Vite + TypeScript`
- 迁移策略：分阶段迁移，最终一次切流
- 兼容策略：低兼容（允许路由和 API 调整）
- 硬约束：已有数据绝不能丢失
- 现有数据源：仅本地 `content/`（JSON + uploads + thumbnails）

## 2. 设计原则

- 数据安全优先于界面重构速度。
- 先稳定数据读写路径，再重构交互与页面结构。
- 所有写操作可追踪、可回滚、可审计。
- 通过阶段门禁控制风险，避免一次性大爆炸上线。
- 可回切优先：任何阶段出现问题，都可以快速切回旧前端入口。

## 3. 目标架构

### 3.1 前端分层

新前端采用 SPA 架构，按“路由页 -> 业务模块 -> 服务层”分层：

- `views/`：页面路由入口（Catalog、Viewer、Admin、Login）
- `features/`：业务模块（catalog、uploads、taxonomy、system、account）
- `stores/`：Pinia 状态层（auth、catalog、admin、system）
- `services/`：API Client、DTO 映射、错误归一化
- `components/`：可复用 UI 组件

### 3.2 路由结构

建议的新路由：

- `/`：公开目录浏览
- `/viewer/:id`：作品预览
- `/login`：登录
- `/admin/dashboard`
- `/admin/content`
- `/admin/uploads`
- `/admin/taxonomy`
- `/admin/system`
- `/admin/account`

说明：由于已选择低兼容，最终 URL 可调整。为降低迁移期影响，保留旧入口到新入口的重定向（过渡期配置），并在发布说明中明确变更。

## 4. 组件与模块边界

优先抽离以下高复用或高复杂度模块：

- `CatalogTabs`：大类/分类标签
- `CardGrid`：卡片列表渲染
- `SearchBox`：前台搜索框
- `AdminListTable`：内容/上传分页列表
- `TaxonomyTree`：分类树
- `TaxonomyEditor`：分类编辑器
- `SystemConfigForm`：系统配置表单
- `ToastHost`：全局提示
- `ConfirmDialog`：统一确认弹窗

边界要求：

- 页面层只负责组合模块，不直接做底层数据请求。
- 组件尽量无副作用，副作用统一收敛到 store action。
- 复杂编辑流（taxonomy、content edit）禁止跨组件共享临时可变对象，统一通过 store patch action 管理。

## 5. 数据流与无损策略

### 5.1 数据来源与权威性

迁移期保持现有本地数据模型不变，以下内容继续作为唯一权威源：

- `content/items.json`
- `content/categories.json`
- `content/uploads/`
- `content/thumbnails/`

不引入新的权威数据库，不做双写，避免一致性风险。

### 5.2 统一请求与写操作规约

- 所有请求通过统一 `ApiClient` 发起。
- 响应先映射为前端 DTO，再进入 store。
- 写操作统一在 Pinia action 中执行，UI 层不直接调用 `fetch`。
- 写操作记录审计日志（时间、动作、目标、结果）到前端运行日志与服务端日志（不记录敏感明文）。

### 5.3 发布阶段写能力控制

- 阶段 1：新前端只读（浏览、搜索、预览、登录校验）
- 阶段 2：逐模块开放写能力（先低风险，再高风险）
- 阶段 3：全量切流

每次开放写能力前必须先执行 `content/` 快照，异常时回切入口，不做数据回迁脚本。

## 6. 错误处理设计

三层错误处理：

- API 层：统一标准错误对象（`status`、`code`、`message`、`retryable`）
- Store 层：区分可重试与不可重试，控制乐观更新与回滚
- UI 层：字段级报错 + 全局 toast + 错误边界页

关键策略：

- 401：清理会话并跳登录
- 409/422：展示业务冲突原因并保留表单输入
- 429/5xx：支持重试与退避提示
- 上传、删除、分类变更等关键操作启用防重复提交与二次确认

## 7. 测试策略与验收门禁

### 7.1 测试金字塔

- 单元测试：`Vitest`（stores、composables、API 映射）
- 组件测试：`Vue Testing Library`（Taxonomy、AdminList、表单校验）
- E2E：`Playwright`（登录、上传、编辑、删除、预览、系统设置）

### 7.2 发布门禁

必须同时满足：

- 新前端只读模式回归通过
- 写操作灰度项逐个通过 E2E
- 发布前自动快照 `content/`
- 可在 5 分钟内回切旧入口

## 8. 分阶段实施计划

### 阶段 A：工程骨架与基础能力

- 初始化 `Vue 3 + Vite + TS`
- 接入 `Vue Router`、`Pinia`
- 建立 `ApiClient`、错误模型、基础布局与主题

### 阶段 B：公开页面迁移

- 迁移首页目录浏览（tabs + 搜索 + 卡片）
- 迁移 viewer 预览流程
- 对齐旧行为并补齐回归用例

### 阶段 C：管理台迁移

- 迁移 dashboard/content/uploads/taxonomy/system/account
- 打通写操作与错误处理统一流程
- 做高频路径压测与 E2E 回归

### 阶段 D：切流与收尾

- 切换默认入口到新前端
- 保留短期回切开关
- 稳定后下线旧前端脚本

## 9. 回滚与应急

- 回滚对象：前端入口映射与静态资源版本
- 回滚手段：切回旧入口（不动数据层）
- 回滚前提：`content/` 快照可用且未损坏
- 回滚目标：5 分钟内恢复可用管理与浏览能力

## 10. 风险与缓解

- 风险：迁移期行为不一致（旧交互细节丢失）  
  缓解：为关键用户路径建立行为基线清单，逐项比对。

- 风险：管理台写操作回归不足  
  缓解：写路径必须有 E2E，未覆盖不准切流。

- 风险：低兼容导致外部链接失效  
  缓解：保留旧地址重定向窗口，并发布迁移公告。

## 11. 完成定义（DoD）

- 新前端覆盖公开页 + 管理台核心功能
- 写操作在灰度与全量阶段均稳定
- 数据目录结构与历史数据保持完整
- 有明确回滚脚本/步骤并演练通过
- 文档与测试门禁可复用到后续迭代

